name: Build and Release Dumbass Submitter

# 触发条件
on:
  workflow_dispatch:  # 手动触发
  push:
    tags:
      - 'v*.*.*'      # push tag 触发，例如 v1.0.0

jobs:
  build-exe:
    runs-on: windows-latest

    # ⚠️ 确保 Release API 权限
    permissions:
      contents: write

    steps:
    # 1. 检出仓库
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2. 设置 Python
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    # 3. 安装依赖
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller requests gh

    # 4. 打包 exe
    - name: Build exe with PyInstaller
      run: |
        pyinstaller --onefile --windowed --name "DumbassSubmitter" "Dumbass Submitter.py"

    # 5. 创建 Release 并上传 exe（使用 gh CLI）
    - name: Create Release and Upload exe
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # 确保 dist 目录存在
        if [ ! -f dist/DumbassSubmitter.exe ]; then
          echo "Error: exe file not found!"
          exit 1
        fi

        # 创建 Release 并上传 exe
        gh release create ${{ github.ref_name }} dist/DumbassSubmitter.exe \
          --title "Release ${{ github.ref_name }}" \
          --notes "自动生成的 exe 文件 - Dumbass Submitter"
